<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>现代聊天应用</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  
  <!-- Tail    Tailwind配置：自定义颜色和字体
    主色调使用蓝色系传达信任和专业感
    辅助色用于强调和交互元素
  -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36BFFA',
            accent: '#7B61FF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .text-shadow {
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .message-appear {
        animation: messageIn 0.3s ease-out forwards;
      }
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      @keyframes messageIn {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark h-screen flex flex-col overflow-hidden">
  <!-- 登录界面 -->
  <div id="loginScreen" class="flex items-center justify-center h-full bg-gradient-to-br from-primary to-accent p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transform transition-all">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
          <i class="fa fa-comments text-3xl text-primary"></i>
        </div>
        <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-dark">聊天应用</h1>
        <p class="text-gray-500 mt-2">请输入用户名登录</p>
      </div>
      
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
              <i class="fa fa-user"></i>
            </span>
            <input 
              type="text" 
              id="username" 
              class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
              placeholder="请输入用户名"
              required
            >
          </div>
        </div>
        
        <button 
          type="submit" 
          class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center"
        >
          <span>登录</span>
          <i class="fa fa-arrow-right ml-2"></i>
        </button>
      </form>
      
      <div id="loginError" class="mt-4 text-danger text-sm hidden"></div>
      
      <div class="mt-6 text-center text-gray-500 text-sm">
        <p>登录即表示您同意我们的<a href="#" class="text-primary hover:underline">服务条款</a></p>
      </div>
    </div>
  </div>

  <!-- 主应用界面 (初始隐藏) -->
  <div id="app" class="flex h-full hidden">
    <!-- 侧边栏 -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col h-full shadow-sm z-10 transition-all duration-300" id="sidebar">
      <!-- 侧边栏头部 -->
      <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h1 class="text-xl font-bold text-primary flex items-center">
          <i class="fa fa-comments-o mr-2"></i>
          <span>聊天应用</span>
        </h1>
        <button id="closeSidebarBtn" class="md:hidden text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <!-- 存储信息 -->
      <div class="p-3 bg-primary/5 border-b border-gray-200">
        <div class="text-xs text-gray-500 mb-1 flex justify-between">
          <span>服务器存储</span>
          <span id="storagePercentage">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
          <div id="storageBar" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1" id="storageText">剩余: 0B / 总容量: 0B</div>
      </div>
      
      <!-- 侧边栏标签 -->
      <div class="flex border-b border-gray-200">
        <button class="tab-btn flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary" data-tab="chats">
          <i class="fa fa-comments mr-1"></i> 聊天
        </button>
        <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="users">
          <i class="fa fa-users mr-1"></i> 在线
        </button>
        <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="files">
          <i class="fa fa-file mr-1"></i> 文件
        </button>
      </div>
      
      <!-- 聊天列表 -->
      <div class="tab-content flex-1 overflow-y-auto scrollbar-hide" id="chats-tab">
        <div class="p-2">
          <button id="newChatBtn" class="w-full py-2 px-3 rounded-lg border border-dashed border-gray-300 text-gray-600 hover:bg-gray-50 text-sm flex items-center justify-center">
            <i class="fa fa-plus mr-1"></i> 新聊天
          </button>
        </div>
        
        <div class="border-b border-gray-100 py-2 px-3">
          <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3">最近聊天</h3>
        </div>
        
        <div id="chatList" class="divide-y divide-gray-100">
          <!-- 聊天项将通过JS动态生成 -->
        </div>
      </div>
      
      <!-- 用户列表 (初始隐藏) -->
      <div class="tab-content hidden flex-1 overflow-y-auto scrollbar-hide" id="users-tab">
        <div class="p-3 border-b border-gray-100">
          <div class="relative">
            <input 
              type="text" 
              id="userSearch" 
              placeholder="搜索用户..." 
              class="w-full pl-9 pr-3 py-2 rounded-lg text-sm bg-gray-100 focus:bg-white border border-transparent focus:border-gray-300 outline-none transition-all"
            >
            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        
        <div id="userList" class="divide-y divide-gray-100">
          <!-- 用户项将通过JS动态生成 -->
        </div>
      </div>
      
      <!-- 文件列表 (初始隐藏) -->
      <div class="tab-content hidden flex-1 overflow-y-auto scrollbar-hide" id="files-tab">
        <div class="p-3 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium">文件管理</h3>
            <div class="flex space-x-1">
              <button id="showAllFiles" class="text-xs py-1 px-2 bg-primary/10 text-primary rounded">全部</button>
              <button id="showMyFiles" class="text-xs py-1 px-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">我的</button>
            </div>
          </div>
        </div>
        
        <div id="fileList" class="p-2">
          <!-- 文件项将通过JS动态生成 -->
        </div>
      </div>
      
      <!-- 当前用户信息 -->
      <div class="p-3 border-t border-gray-200 flex items-center">
        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-medium">
          <span id="currentUserInitials">U</span>
        </div>
        <div class="ml-3 flex-1 min-w-0">
          <p id="currentUserName" class="text-sm font-medium truncate">用户名</p>
          <p id="currentUserStatus" class="text-xs text-gray-500">在线</p>
        </div>
        <button id="logoutBtn" class="text-gray-500 hover:text-danger p-1">
          <i class="fa fa-sign-out"></i>
        </button>
      </div>
    </aside>

    <!-- 主聊天区域 -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50">
      <!-- 聊天头部 -->
      <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm">
        <button id="openSidebarBtn" class="md:hidden mr-3 text-gray-500">
          <i class="fa fa-bars"></i>
        </button>
        
        <div class="flex items-center">
          <div id="chatAvatar" class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-medium">
            <span>C</span>
          </div>
          <div class="ml-3">
            <h2 id="chatTitle" class="font-medium">选择一个聊天</h2>
            <p id="chatMembers" class="text-xs text-gray-500">0 名成员</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <button id="showFileListBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded-full transition-colors">
            <i class="fa fa-paperclip"></i>
          </button>
          <button id="showRoomInfoBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded-full transition-colors">
            <i class="fa fa-info-circle"></i>
          </button>
        </div>
      </header>
      
      <!-- 聊天消息区域 -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
        <div class="flex items-center justify-center py-8">
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
              <i class="fa fa-comments text-2xl text-primary/70"></i>
            </div>
            <h3 class="text-gray-500 font-medium">开始聊天吧</h3>
            <p class="text-gray-400 text-sm mt-1">选择一个聊天或创建新聊天</p>
          </div>
        </div>
      </div>
      
      <!-- 输入区域 -->
      <div class="bg-white border-t border-gray-200 p-3">
        <!-- 输入工具栏 -->
        <div class="flex items-center justify-between mb-2 px-1">
          <div class="flex space-x-1">
            <button id="attachFileBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded transition-colors" title="上传文件">
              <i class="fa fa-file-o"></i>
            </button>
            <button id="takePhotoBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded transition-colors" title="拍照">
              <i class="fa fa-camera"></i>
            </button>
            <button id="recordVoiceBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded transition-colors" title="录制语音">
              <i class="fa fa-microphone"></i>
            </button>
            <button id="encryptToggleBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-primary/10 rounded transition-colors" title="加密消息">
              <i class="fa fa-lock"></i>
            </button>
          </div>
          
          <div>
            <button id="expiryToggleBtn" class="text-xs py-1 px-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200" title="设置消息过期时间">
              <i class="fa fa-clock-o mr-1"></i> 永久
            </button>
          </div>
        </div>
        
        <!-- 消息输入框 -->
        <div class="relative">
          <textarea 
            id="messageInput" 
            class="w-full p-3 pr-12 rounded-xl border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none resize-none"
            placeholder="输入消息..."
            rows="3"
          ></textarea>
          
          <button id="sendMessageBtn" class="absolute right-3 bottom-3 bg-primary hover:bg-primary/90 text-white rounded-full p-2 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fa fa-paper-plane"></i>
          </button>
        </div>
        
        <!-- 语音录制指示器 (初始隐藏) -->
        <div id="voiceRecordingIndicator" class="hidden mt-2 p-3 bg-red-50 border border-red-100 rounded-lg flex items-center">
          <div class="animate-pulse w-3 h-3 rounded-full bg-danger mr-2"></div>
          <span class="text-sm text-red-600">正在录制语音...</span>
          <div class="ml-auto flex space-x-2">
            <button id="cancelVoiceBtn" class="text-sm text-gray-500 hover:text-gray-700">取消</button>
            <button id="stopVoiceBtn" class="text-sm text-danger hover:text-red-700">完成</button>
          </div>
        </div>
        
        <!-- 文件上传进度 (初始隐藏) -->
        <div id="uploadProgressContainer" class="hidden mt-2">
          <div class="text-xs text-gray-500 mb-1 flex justify-between">
            <span id="uploadFileName">上传中...</span>
            <span id="uploadProgressText">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="uploadProgressBar" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 创建房间模态框 (初始隐藏) -->
  <div id="createRoomModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform transition-all">
      <div class="p-5 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">创建群聊</h3>
        <button id="closeCreateRoomModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="p-5">
        <form id="createRoomForm">
          <div class="mb-4">
            <label for="roomName" class="block text-sm font-medium text-gray-700 mb-1">群聊名称</label>
            <input 
              type="text" 
              id="roomName" 
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
              placeholder="输入群聊名称"
              required
            >
          </div>
          
          <button 
            type="submit" 
            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all"
          >
            创建群聊
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 添加好友模态框 (初始隐藏) -->
  <div id="addFriendModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform transition-all">
      <div class="p-5 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">添加好友</h3>
        <button id="closeAddFriendModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="p-5">
        <form id="addFriendForm">
          <div class="mb-4">
            <label for="friendUserId" class="block text-sm font-medium text-gray-700 mb-1">用户ID</label>
            <input 
              type="text" 
              id="friendUserId" 
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
              placeholder="输入用户ID"
              required
            >
          </div>
          
          <button 
            type="submit" 
            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all"
          >
            发送请求
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 房间信息模态框 (初始隐藏) -->
  <div id="roomInfoModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto transform transition-all">
      <div class="p-5 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">群聊信息</h3>
        <button id="closeRoomInfoModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="p-5">
        <div class="flex items-center mb-5">
          <div id="roomInfoAvatar" class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center text-primary font-medium text-lg">
            <span>R</span>
          </div>
          <div class="ml-3">
            <h4 id="roomInfoName" class="font-medium">群聊名称</h4>
            <p id="roomInfoCreator" class="text-xs text-gray-500">创建者: 未知</p>
          </div>
        </div>
        
        <div class="mb-5">
          <h4 class="text-sm font-medium mb-2">成员 ( <span id="roomMemberCount">0</span> )</h4>
          <div id="roomMembersList" class="space-y-2 max-h-40 overflow-y-auto scrollbar-hide">
            <!-- 成员列表将通过JS动态生成 -->
          </div>
        </div>
        
        <div class="border-t border-gray-100 pt-4">
          <button id="leaveRoomBtn" class="w-full text-danger hover:bg-danger/5 font-medium py-2.5 px-4 rounded-lg transition-all border border-danger/20">
            退出群聊
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 文件保质期设置模态框 (初始隐藏) -->
  <div id="fileExpiryModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm transform transition-all">
      <div class="p-5 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">设置文件保质期</h3>
        <button id="closeFileExpiryModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="p-5">
        <form id="fileExpiryForm">
          <input type="hidden" id="expiryFileId">
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">过期时间</label>
            <div class="grid grid-cols-3 gap-2">
              <button type="button" class="expiry-option py-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all" data-expiry="3600000">1小时</button>
              <button type="button" class="expiry-option py-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all" data-expiry="86400000">1天</button>
              <button type="button" class="expiry-option py-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all" data-expiry="604800000">1周</button>
              <button type="button" class="expiry-option py-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all" data-expiry="2592000000">30天</button>
              <button type="button" class="expiry-option py-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all" data-expiry="0">永久</button>
            </div>
          </div>
          
          <button 
            type="submit" 
            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all"
          >
            保存设置
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 主应用脚本 -->
  <script>
    // 全局状态管理
    const state = {
      socket: null,
      currentUser: null,
      currentChat: null, // { type: 'room'|'private', id: 'xxx', name: 'xxx' }
      users: new Map(),
      rooms: new Map(),
      friends: new Map(),
      friendRequests: [],
      uploads: new Map(),
      downloads: new Map(),
      messages: new Map(), // chatId -> [messages]
      files: new Map(), // fileId -> fileInfo
      isEncrypting: false,
      selectedExpiryTime: null // 消息/文件过期时间 (毫秒)
    };

    // DOM 元素
    const elements = {
      // 登录界面
      loginScreen: document.getElementById('loginScreen'),
      loginForm: document.getElementById('loginForm'),
      usernameInput: document.getElementById('username'),
      loginError: document.getElementById('loginError'),
      
      // 主应用界面
      app: document.getElementById('app'),
      sidebar: document.getElementById('sidebar'),
      closeSidebarBtn: document.getElementById('closeSidebarBtn'),
      openSidebarBtn: document.getElementById('openSidebarBtn'),
      currentUserInitials: document.getElementById('currentUserInitials'),
      currentUserName: document.getElementById('currentUserName'),
      logoutBtn: document.getElementById('logoutBtn'),
      
      // 标签切换
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabContents: document.querySelectorAll('.tab-content'),
      
      // 聊天列表
      chatList: document.getElementById('chatList'),
      newChatBtn: document.getElementById('newChatBtn'),
      
      // 用户列表
      userList: document.getElementById('userList'),
      userSearch: document.getElementById('userSearch'),
      
      // 文件列表
      fileList: document.getElementById('fileList'),
      showAllFiles: document.getElementById('showAllFiles'),
      showMyFiles: document.getElementById('showMyFiles'),
      
      // 聊天区域
      chatTitle: document.getElementById('chatTitle'),
      chatAvatar: document.getElementById('chatAvatar'),
      chatMembers: document.getElementById('chatMembers'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendMessageBtn: document.getElementById('sendMessageBtn'),
      
      // 输入工具栏
      attachFileBtn: document.getElementById('attachFileBtn'),
      takePhotoBtn: document.getElementById('takePhotoBtn'),
      recordVoiceBtn: document.getElementById('recordVoiceBtn'),
      encryptToggleBtn: document.getElementById('encryptToggleBtn'),
      expiryToggleBtn: document.getElementById('expiryToggleBtn'),
      
      // 语音录制
      voiceRecordingIndicator: document.getElementById('voiceRecordingIndicator'),
      cancelVoiceBtn: document.getElementById('cancelVoiceBtn'),
      stopVoiceBtn: document.getElementById('stopVoiceBtn'),
      
      // 上传进度
      uploadProgressContainer: document.getElementById('uploadProgressContainer'),
      uploadFileName: document.getElementById('uploadFileName'),
      uploadProgressBar: document.getElementById('uploadProgressBar'),
      uploadProgressText: document.getElementById('uploadProgressText'),
      
      // 模态框
      createRoomModal: document.getElementById('createRoomModal'),
      closeCreateRoomModal: document.getElementById('closeCreateRoomModal'),
      createRoomForm: document.getElementById('createRoomForm'),
      roomNameInput: document.getElementById('roomName'),
      
      addFriendModal: document.getElementById('addFriendModal'),
      closeAddFriendModal: document.getElementById('closeAddFriendModal'),
      addFriendForm: document.getElementById('addFriendForm'),
      friendUserIdInput: document.getElementById('friendUserId'),
      
      roomInfoModal: document.getElementById('roomInfoModal'),
      closeRoomInfoModal: document.getElementById('closeRoomInfoModal'),
      roomInfoName: document.getElementById('roomInfoName'),
      roomInfoCreator: document.getElementById('roomInfoCreator'),
      roomMemberCount: document.getElementById('roomMemberCount'),
      roomMembersList: document.getElementById('roomMembersList'),
      leaveRoomBtn: document.getElementById('leaveRoomBtn'),
      
      fileExpiryModal: document.getElementById('fileExpiryModal'),
      closeFileExpiryModal: document.getElementById('closeFileExpiryModal'),
      fileExpiryForm: document.getElementById('fileExpiryForm'),
      expiryFileId: document.getElementById('expiryFileId'),
      expiryOptions: document.querySelectorAll('.expiry-option'),
      
      // 存储信息
      storageBar: document.getElementById('storageBar'),
      storagePercentage: document.getElementById('storagePercentage'),
      storageText: document.getElementById('storageText'),
      
      // 其他按钮
      showFileListBtn: document.getElementById('showFileListBtn'),
      showRoomInfoBtn: document.getElementById('showRoomInfoBtn')
    };

    // 工具函数
    const utils = {
      // 格式化文件大小
      formatFileSize(bytes) {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
      },
      
      // 格式化时间
      formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      },
      
      // 生成用户头像首字母
      getInitials(name) {
        return name.charAt(0).toUpperCase();
      },
      
      // 生成随机颜色
      getRandomColor(name) {
        // 基于名称生成一致的颜色
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const color = `hsl(${hash % 360}, 70%, 85%)`;
        const textColor = `hsl(${hash % 360}, 70%, 35%)`;
        return { bgColor: color, textColor };
      },
      
      // 获取私聊ID
      getPrivateChatId(userId1, userId2) {
        return [userId1, userId2].sort().join('-');
      },
      
      // 加密消息 (模拟)
      encryptMessage(text) {
        // 实际应用中应使用真实加密算法
        return btoa(text);
      },
      
      // 解密消息 (模拟)
      decryptMessage(text) {
        try {
          return atob(text);
        } catch (e) {
          return text;
        }
      }
    };

    // UI 更新函数
    const ui = {
      // 显示登录错误
      showLoginError(message) {
        elements.loginError.textContent = message;
        elements.loginError.classList.remove('hidden');
        setTimeout(() => {
          elements.loginError.classList.add('hidden');
        }, 3000);
      },
      
      // 切换到应用界面
      showApp() {
        elements.loginScreen.classList.add('hidden');
        elements.app.classList.remove('hidden');
        
        // 设置当前用户信息
        elements.currentUserInitials.textContent = utils.getInitials(state.currentUser.name);
        elements.currentUserName.textContent = state.currentUser.name;
      },
      
      // 更新用户列表
      updateUserList(users) {
        elements.userList.innerHTML = '';
        
        users.forEach(user => {
          if (user.id === state.socket.id) return; // 跳过当前用户
          
          const color = utils.getRandomColor(user.name);
          const userEl = document.createElement('div');
          userEl.className = 'p-3 hover:bg-gray-50 flex items-center justify-between cursor-pointer transition-colors';
          userEl.innerHTML = `
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color.bgColor}; color: ${color.textColor}">
                ${utils.getInitials(user.name)}
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium">${user.name}</p>
                <p class="text-xs text-gray-500">${user.hasPublicKey ? '已设置密钥' : '未设置密钥'}</p>
              </div>
            </div>
            <button class="add-friend-btn text-xs py-1 px-2 bg-primary/10 text-primary rounded-full" data-user-id="${user.id}">
              ${state.friends.has(user.id) ? '已添加' : '添加'}
            </button>
          `;
          
          elements.userList.appendChild(userEl);
          
          // 添加好友按钮事件
          if (!state.friends.has(user.id)) {
            userEl.querySelector('.add-friend-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              elements.friendUserIdInput.value = user.id;
              elements.addFriendModal.classList.remove('hidden');
            });
          }
          
          // 点击用户开始私聊
          userEl.addEventListener('click', () => {
            const chatId = utils.getPrivateChatId(state.socket.id, user.id);
            state.currentChat = {
              type: 'private',
              id: chatId,
              name: user.name,
              targetUserId: user.id
            };
            ui.updateChatHeader();
            ui.loadMessages(chatId);
            ui.switchTab('chats');
          });
        });
      },
      
      // 更新聊天列表
      updateChatList() {
        elements.chatList.innerHTML = '';
        
        // 添加房间聊天
        state.rooms.forEach(room => {
          const color = utils.getRandomColor(room.name);
          const chatEl = document.createElement('div');
          chatEl.className = 'p-3 hover:bg-gray-50 flex items-center cursor-pointer transition-colors';
          chatEl.innerHTML = `
            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color.bgColor}; color: ${color.textColor}">
              <i class="fa fa-users"></i>
            </div>
            <div class="ml-3 flex-1 min-w-0">
              <p class="text-sm font-medium truncate">${room.name}</p>
              <p class="text-xs text-gray-500 truncate">${room.memberCount} 名成员</p>
            </div>
          `;
          
          chatEl.addEventListener('click', () => {
            state.currentChat = {
              type: 'room',
              id: room.id,
              name: room.name
            };
            ui.updateChatHeader();
            ui.loadMessages(room.id);
          });
          
          elements.chatList.appendChild(chatEl);
        });
        
        // 添加私聊
        state.friends.forEach(friendId => {
          const friend = state.users.get(friendId);
          if (!friend) return;
          
          const color = utils.getRandomColor(friend.name);
          const chatId = utils.getPrivateChatId(state.socket.id, friendId);
          const chatEl = document.createElement('div');
          chatEl.className = 'p-3 hover:bg-gray-50 flex items-center cursor-pointer transition-colors';
          chatEl.innerHTML = `
            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color.bgColor}; color: ${color.textColor}">
              ${utils.getInitials(friend.name)}
            </div>
            <div class="ml-3 flex-1 min-w-0">
              <p class="text-sm font-medium truncate">${friend.name}</p>
              <p class="text-xs text-gray-500 truncate">私聊</p>
            </div>
          `;
          
          chatEl.addEventListener('click', () => {
            state.currentChat = {
              type: 'private',
              id: chatId,
              name: friend.name,
              targetUserId: friendId
            };
            ui.updateChatHeader();
            ui.loadMessages(chatId);
          });
          
          elements.chatList.appendChild(chatEl);
        });
      },
      
      // 更新聊天头部信息
      updateChatHeader() {
        if (!state.currentChat) {
          elements.chatTitle.textContent = '选择一个聊天';
          elements.chatAvatar.innerHTML = '<i class="fa fa-comments"></i>';
          elements.chatMembers.textContent = '0 名成员';
          return;
        }
        
        elements.chatTitle.textContent = state.currentChat.name;
        
        // 设置头像
        if (state.currentChat.type === 'room') {
          const color = utils.getRandomColor(state.currentChat.name);
          elements.chatAvatar.innerHTML = `<i class="fa fa-users"></i>`;
          elements.chatAvatar.style.backgroundColor = color.bgColor;
          elements.chatAvatar.style.color = color.textColor;
          
          // 更新成员数量
          const room = state.rooms.get(state.currentChat.id);
          elements.chatMembers.textContent = `${room ? room.memberCount : 0} 名成员`;
        } else {
          const friend = state.users.get(state.currentChat.targetUserId);
          if (friend) {
            const color = utils.getRandomColor(friend.name);
            elements.chatAvatar.textContent = utils.getInitials(friend.name);
            elements.chatAvatar.style.backgroundColor = color.bgColor;
            elements.chatAvatar.style.color = color.textColor;
            elements.chatMembers.textContent = '私聊';
          }
        }
      },
      
      // 加载并显示消息
      loadMessages(chatId) {
        elements.messagesContainer.innerHTML = '';
        
        const messages = state.messages.get(chatId) || [];
        if (messages.length === 0) {
          elements.messagesContainer.innerHTML = `
            <div class="flex items-center justify-center py-8">
              <div class="text-center">
                <p class="text-gray-500">没有消息</p>
                <p class="text-gray-400 text-sm mt-1">开始发送第一条消息吧</p>
              </div>
            </div>
          `;
          return;
        }
        
        messages.forEach(message => {
          ui.addMessage(message);
        });
        
        // 滚动到底部
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
      },
      
      // 添加新消息
      addMessage(message) {
        const isCurrentUser = message.userId === state.socket.id;
        const messageEl = document.createElement('div');
        messageEl.className = `message-appear ${isCurrentUser ? 'flex justify-end' : 'flex'}`;
        
        // 处理消息内容
        let messageContent = '';
        if (message.type === 'text') {
          // 解密消息（如果是加密的）
          const text = message.isEncrypted ? utils.decryptMessage(message.text) : message.text;
          messageContent = `
            <div class="max-w-[80%] px-4 py-2.5 rounded-lg ${isCurrentUser ? 'bg-primary text-white' : 'bg-white border border-gray-200'}">
              ${text}
              ${message.isEncrypted ? '<span class="inline-block ml-1 text-xs opacity-70"><i class="fa fa-lock"></i></span>' : ''}
              <div class="text-right text-xs mt-1 opacity-70">${message.time}</div>
            </div>
          `;
        } else if (message.type === 'file') {
          const fileIcon = message.isImage ? 
            `<img src="${message.thumbnailUrl || message.fileUrl}" class="w-16 h-16 object-cover rounded mb-1">` : 
            `<i class="fa fa-file-o text-2xl mb-1"></i>`;
            
          messageContent = `
            <div class="max-w-[80%] px-4 py-3 rounded-lg ${isCurrentUser ? 'bg-primary text-white' : 'bg-white border border-gray-200'}">
              <div class="flex items-center">
                <div class="mr-3">
                  ${fileIcon}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium truncate">${message.fileName}</p>
                  <p class="text-xs ${isCurrentUser ? 'text-white/70' : 'text-gray-500'}">${utils.formatFileSize(message.fileSize)}</p>
                  <p class="text-xs ${isCurrentUser ? 'text-white/70' : 'text-gray-500'} mt-1">
                    ${message.expiryTimeFormatted ? `过期时间: ${message.expiryTimeFormatted}` : ''}
                  </p>
                </div>
              </div>
              <a href="${message.fileUrl}" download="${message.fileName}" class="inline-block mt-2 text-xs ${isCurrentUser ? 'text-white/90 hover:text-white' : 'text-primary hover:text-primary/80'}">
                <i class="fa fa-download mr-1"></i> 下载
              </a>
              ${message.isImage && message.originalUrl ? 
                `<a href="${message.originalUrl}" target="_blank" class="inline-block mt-2 ml-2 text-xs ${isCurrentUser ? 'text-white/90 hover:text-white' : 'text-primary hover:text-primary/80'}">
                  <i class="fa fa-expand mr-1"></i> 查看原图
                </a>` : ''
              }
              ${isCurrentUser ? 
                `<button class="set-expiry-btn inline-block mt-2 ml-2 text-xs text-white/90 hover:text-white" data-file-id="${message.fileId}">
                  <i class="fa fa-clock-o mr-1"></i> 设置过期
                </button>` : ''
              }
              <div class="text-right text-xs mt-1 opacity-70">${message.time}</div>
            </div>
          `;
        } else if (message.type === 'voice') {
          messageContent = `
            <div class="max-w-[80%] px-4 py-3 rounded-lg ${isCurrentUser ? 'bg-primary text-white' : 'bg-white border border-gray-200'}">
              <p class="text-sm mb-2">语音消息 (${Math.round(message.duration / 1000)}秒)</p>
              <audio controls class="w-full">
                <source src="${message.fileUrl}" type="audio/webm">
                您的浏览器不支持音频播放
              </audio>
              <div class="text-right text-xs mt-1 opacity-70">${message.time}</div>
            </div>
          `;
        } else if (message.type === 'system') {
          messageEl.className = 'flex justify-center';
          messageContent = `
            <div class="px-3 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">
              ${message.text}
            </div>
          `;
        }
        
        messageEl.innerHTML = messageContent;
        elements.messagesContainer.appendChild(messageEl);
        
        // 设置过期按钮事件
        const expiryBtn = messageEl.querySelector('.set-expiry-btn');
        if (expiryBtn) {
          expiryBtn.addEventListener('click', () => {
            elements.expiryFileId.value = message.fileId;
            elements.fileExpiryModal.classList.remove('hidden');
          });
        }
        
        // 滚动到底部
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
      },
      
      // 更新文件列表
      updateFileList(files) {
        elements.fileList.innerHTML = '';
        
        if (files.length === 0) {
          elements.fileList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-file-o text-3xl mb-2"></i>
              <p>没有文件</p>
            </div>
          `;
          return;
        }
        
        files.forEach(file => {
          const fileEl = document.createElement('div');
          fileEl.className = 'p-3 bg-white rounded-lg border border-gray-100 mb-2 hover:border-primary/30 transition-all';
          
          const fileIcon = file.isImage ? 
            `<img src="${file.thumbnailUrl || file.url}" class="w-12 h-12 object-cover rounded">` : 
            `<i class="fa fa-file-o text-2xl"></i>`;
            
          const isOwner = file.userId === state.socket.id;
          
          fileEl.innerHTML = `
            <div class="flex items-center">
              <div class="mr-3">
                ${fileIcon}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium truncate">${file.name}</p>
                <p class="text-xs text-gray-500">${file.user} · ${file.time}</p>
                <p class="text-xs text-gray-500 mt-1">
                  ${utils.formatFileSize(file.size)} · 
                  ${file.expiryTimeFormatted || '永久'}
                </p>
              </div>
              <div class="ml-2 flex flex-col items-end">
                <a href="${file.url}" download="${file.name}" class="text-primary hover:text-primary/80 p-1">
                  <i class="fa fa-download"></i>
                </a>
                ${isOwner ? `
                  <button class="set-expiry-btn text-gray-500 hover:text-primary p-1 mt-1" data-file-id="${file.id}">
                    <i class="fa fa-clock-o"></i>
                  </button>
                ` : ''}
              </div>
            </div>
          `;
          
          elements.fileList.appendChild(fileEl);
          
          // 设置过期按钮事件
          const expiryBtn = fileEl.querySelector('.set-expiry-btn');
          if (expiryBtn) {
            expiryBtn.addEventListener('click', () => {
              elements.expiryFileId.value = file.id;
              elements.fileExpiryModal.classList.remove('hidden');
            });
          }
        });
      },
      
      // 更新房间信息模态框
      updateRoomInfoModal(roomId) {
        const room = state.rooms.get(roomId);
        if (!room) return;
        
        elements.roomInfoName.textContent = room.name;
        elements.roomInfoCreator.textContent = `创建者: ${room.creator}`;
        elements.roomMemberCount.textContent = room.memberCount;
        
        // 清空成员列表
        elements.roomMembersList.innerHTML = '';
        
        // 添加成员
        room.members.forEach(memberId => {
          const user = state.users.get(memberId);
          if (!user) return;
          
          const color = utils.getRandomColor(user.name);
          const memberEl = document.createElement('div');
          memberEl.className = 'flex items-center';
          memberEl.innerHTML = `
            <div class="w-6 h-6 rounded-full flex items-center justify-center" style="background-color: ${color.bgColor}; color: ${color.textColor}">
              ${utils.getInitials(user.name)}
            </div>
            <span class="ml-2 text-sm">${user.name}</span>
            ${room.creator === user.name ? 
              '<span class="ml-2 text-xs bg-primary/10 text-primary px-1.5 py-0.5 rounded">创建者</span>' : ''
            }
          `;
          
          elements.roomMembersList.appendChild(memberEl);
        });
      },
      
      // 更新上传进度
      updateUploadProgress(progress, fileName, percent) {
        elements.uploadProgressContainer.classList.remove('hidden');
        elements.uploadFileName.textContent = fileName;
        elements.uploadProgressBar.style.width = `${percent}%`;
        elements.uploadProgressText.textContent = `${percent}%`;
        
        if (percent === 100) {
          setTimeout(() => {
            elements.uploadProgressContainer.classList.add('hidden');
            elements.uploadProgressBar.style.width = '0%';
          }, 1000);
        }
      },
      
      // 更新存储信息
      updateStorageInfo(storageInfo) {
        elements.storageBar.style.width = `${storageInfo.usedPercentage}%`;
        elements.storagePercentage.textContent = `${storageInfo.usedPercentage}%`;
        elements.storageText.textContent = `剩余: ${storageInfo.freeFormatted} / 总容量: ${storageInfo.totalFormatted}`;
        
        // 如果存储空间不足，显示警告
        if (storageInfo.usedPercentage > 90) {
          elements.storageBar.classList.add('bg-warning');
        } else {
          elements.storageBar.classList.remove('bg-warning');
        }
      },
      
      // 切换标签
      switchTab(tabId) {
        elements.tabBtns.forEach(btn => {
          if (btn.dataset.tab === tabId) {
            btn.classList.add('text-primary', 'border-b-2', 'border-primary');
            btn.classList.remove('text-gray-500');
          } else {
            btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
            btn.classList.add('text-gray-500');
          }
        });
        
        elements.tabContents.forEach(content => {
          if (content.id === `${tabId}-tab`) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
        });
      },
      
      // 显示消息通知
      showNotification(message, type = 'info') {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-10 opacity-0`;
        
        // 设置样式
        let bgColor, textColor, icon;
        switch (type) {
          case 'success':
            bgColor = 'bg-success';
            textColor = 'text-white';
            icon = 'fa-check-circle';
            break;
          case 'error':
            bgColor = 'bg-danger';
            textColor = 'text-white';
            icon = 'fa-exclamation-circle';
            break;
          case 'warning':
            bgColor = 'bg-warning';
            textColor = 'text-white';
            icon = 'fa-exclamation-triangle';
            break;
          default:
            bgColor = 'bg-primary';
            textColor = 'text-white';
            icon = 'fa-info-circle';
        }
        
        notification.classList.add(bgColor, textColor);
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fa ${icon} mr-2"></i>
            <span>${message}</span>
          </div>
        `;
        
        // 添加到页面
        document.body.appendChild(notification);
        
        // 显示动画
        setTimeout(() => {
          notification.classList.remove('translate-y-10', 'opacity-0');
        }, 100);
        
        // 自动消失
        setTimeout(() => {
          notification.classList.add('translate-y-10', 'opacity-0');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
    };

    // 事件处理函数
    const events = {
      // 初始化事件监听
      init() {
        // 登录表单提交
        elements.loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const username = elements.usernameInput.value.trim();
          if (username) {
            events.login(username);
          }
        });
        
        // 登出按钮
        elements.logoutBtn.addEventListener('click', events.logout);
        
        // 标签切换
        elements.tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            ui.switchTab(btn.dataset.tab);
          });
        });
        
        // 侧边栏切换 (移动端)
        elements.closeSidebarBtn.addEventListener('click', () => {
          elements.sidebar.classList.add('-translate-x-full');
        });
        
        elements.openSidebarBtn.addEventListener('click', () => {
          elements.sidebar.classList.remove('-translate-x-full');
        });
        
        // 发送消息按钮
        elements.sendMessageBtn.addEventListener('click', events.sendMessage);
        
        // 消息输入框事件
        elements.messageInput.addEventListener('input', () => {
          elements.sendMessageBtn.disabled = elements.messageInput.value.trim() === '';
        });
        
        elements.messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (elements.messageInput.value.trim() !== '') {
              events.sendMessage();
            }
          }
        });
        
        // 创建群聊模态框
        elements.newChatBtn.addEventListener('click', () => {
          elements.createRoomModal.classList.remove('hidden');
        });
        
        elements.closeCreateRoomModal.addEventListener('click', () => {
          elements.createRoomModal.classList.add('hidden');
        });
        
        elements.createRoomForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const roomName = elements.roomNameInput.value.trim();
          if (roomName) {
            events.createRoom(roomName);
            elements.roomNameInput.value = '';
            elements.createRoomModal.classList.add('hidden');
          }
        });
        
        // 添加好友模态框
        elements.closeAddFriendModal.addEventListener('click', () => {
          elements.addFriendModal.classList.add('hidden');
        });
        
        elements.addFriendForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const userId = elements.friendUserIdInput.value.trim();
          if (userId) {
            events.sendFriendRequest(userId);
            elements.friendUserIdInput.value = '';
            elements.addFriendModal.classList.add('hidden');
          }
        });
        
        // 房间信息模态框
        elements.showRoomInfoBtn.addEventListener('click', () => {
          if (state.currentChat && state.currentChat.type === 'room') {
            ui.updateRoomInfoModal(state.currentChat.id);
            elements.roomInfoModal.classList.remove('hidden');
          }
        });
        
        elements.closeRoomInfoModal.addEventListener('click', () => {
          elements.roomInfoModal.classList.add('hidden');
        });
        
        elements.leaveRoomBtn.addEventListener('click', () => {
          if (state.currentChat && state.currentChat.type === 'room') {
            // 这里应该实现退出房间的逻辑
            ui.showNotification('退出房间功能已触发', 'info');
            elements.roomInfoModal.classList.add('hidden');
          }
        });
        
        // 文件保质期模态框
        elements.closeFileExpiryModal.addEventListener('click', () => {
          elements.fileExpiryModal.classList.add('hidden');
        });
        
        elements.expiryOptions.forEach(option => {
          option.addEventListener('click', () => {
            elements.expiryOptions.forEach(opt => opt.classList.remove('border-primary', 'bg-primary/5'));
            option.classList.add('border-primary', 'bg-primary/5');
            state.selectedExpiryTime = option.dataset.expiry === '0' ? null : parseInt(option.dataset.expiry);
          });
        });
        
        elements.fileExpiryForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const fileId = elements.expiryFileId.value;
          if (fileId && state.selectedExpiryTime !== undefined) {
            events.updateFileExpiry(fileId, state.selectedExpiryTime);
            elements.fileExpiryModal.classList.add('hidden');
          }
        });
        
        // 加密切换按钮
        elements.encryptToggleBtn.addEventListener('click', () => {
          state.isEncrypting = !state.isEncrypting;
          if (state.isEncrypting) {
            elements.encryptToggleBtn.classList.add('text-primary');
            elements.encryptToggleBtn.classList.remove('text-gray-500');
          } else {
            elements.encryptToggleBtn.classList.remove('text-primary');
            elements.encryptToggleBtn.classList.add('text-gray-500');
          }
        });
        
        // 过期时间切换按钮
        elements.expiryToggleBtn.addEventListener('click', () => {
          const expiryOptions = [
            { time: null, text: '永久' },
            { time: 3600000, text: '1小时' },
            { time: 86400000, text: '1天' },
            { time: 604800000, text: '1周' }
          ];
          
          // 找到当前选项的索引
          const currentIndex = expiryOptions.findIndex(opt => opt.time === state.selectedExpiryTime);
          // 切换到下一个选项
          const nextIndex = (currentIndex + 1) % expiryOptions.length;
          state.selectedExpiryTime = expiryOptions[nextIndex].time;
          
          elements.expiryToggleBtn.innerHTML = `<i class="fa fa-clock-o mr-1"></i> ${expiryOptions[nextIndex].text}`;
        });
        
        // 上传文件按钮
        elements.attachFileBtn.addEventListener('click', events.uploadFile);
        
        // 录制语音按钮
        elements.recordVoiceBtn.addEventListener('click', events.startVoiceRecording);
        elements.cancelVoiceBtn.addEventListener('click', events.cancelVoiceRecording);
        elements.stopVoiceBtn.addEventListener('click', events.stopVoiceRecording);
        
        // 显示文件列表按钮
        elements.showFileListBtn.addEventListener('click', () => {
          if (state.currentChat) {
            events.getConversationFiles();
            ui.switchTab('files');
          } else {
            ui.showNotification('请先选择一个聊天', 'warning');
          }
        });
      },
      
      // 登录
      login(username) {
        // 连接到服务器
        state.socket = io();
        
        // 监听连接成功
        state.socket.on('connect', () => {
          console.log('Connected to server');
          state.socket.emit('login', username);
          state.currentUser = { name: username, id: state.socket.id };
        });
        
        // 登录错误
        state.socket.on('loginError', (message) => {
          ui.showLoginError(message);
        });
        
        // 登录成功后设置事件监听
        state.socket.on('userList', (users) => {
          state.users.clear();
          users.forEach(user => {
            state.users.set(user.id, user);
          });
          ui.updateUserList(Array.from(state.users.values()));
          ui.showApp();
        });
        
        // 房间列表更新
        state.socket.on('roomList', (rooms) => {
          state.rooms.clear();
          rooms.forEach(room => {
            state.rooms.set(room.id, room);
          });
          ui.updateChatList();
        });
        
        // 好友列表更新
        state.socket.on('friendList', (friends) => {
          state.friends.clear();
          friends.forEach(friend => {
            state.friends.set(friend.id, friend);
          });
          ui.updateChatList();
        });
        
        // 好友请求
        state.socket.on('friendRequests', (requests) => {
          state.friendRequests = requests;
        });
        
        // 新好友请求
        state.socket.on('newFriendRequest', (request) => {
          state.friendRequests.push(request);
          ui.showNotification(`收到来自 ${request.fromName} 的好友请求`, 'info');
        });
        
        // 好友请求响应
        state.socket.on('friendRequestResponse', ({ accepted, targetName }) => {
          if (accepted) {
            ui.showNotification(`已与 ${targetName} 成为好友`, 'success');
          } else {
            ui.showNotification(`${targetName} 拒绝了您的好友请求`, 'info');
          }
        });
        
        // 新消息
        state.socket.on('newMessage', (message) => {
          // 将消息添加到对应的聊天
          const chatId = message.roomId || utils.getPrivateChatId(state.socket.id, message.userId);
          
          if (!state.messages.has(chatId)) {
            state.messages.set(chatId, []);
          }
          
          state.messages.get(chatId).push(message);
          
          // 如果是当前聊天，直接显示
          if (state.currentChat && state.currentChat.id === chatId) {
            ui.addMessage(message);
          } else {
            // 否则显示通知
            const chatName = message.roomId ? 
              state.rooms.get(message.roomId)?.name : 
              state.users.get(message.userId)?.name || '未知';
            ui.showNotification(`来自 ${chatName} 的新消息`, 'info');
          }
          
          // 更新聊天列表（可以添加未读消息提示）
          ui.updateChatList();
        });
        
        // 系统消息
        state.socket.on('systemMessage', (message) => {
          if (state.currentChat && state.currentChat.id === message.roomId) {
            ui.addMessage(message);
          }
        });
        
        // 存储信息更新
        state.socket.on('storageInfo', (storageInfo) => {
          ui.updateStorageInfo(storageInfo);
        });
        
        // 房间创建成功
        state.socket.on('roomCreated', (room) => {
          ui.showNotification(`房间 ${room.name} 创建成功`, 'success');
        });
        
        // 房间加入请求响应
        state.socket.on('roomRequestResponse', ({ accepted, roomName }) => {
          if (accepted) {
            ui.showNotification(`已加入房间 ${roomName}`, 'success');
          } else {
            ui.showNotification(`加入房间 ${roomName} 的请求被拒绝`, 'info');
          }
        });
        
        // 上传初始化响应
        state.socket.on('uploadInitialized', (data) => {
          state.uploads.set(data.uploadId, {
            id: data.uploadId,
            fileName: data.fileName,
            fileSize: data.fileSize,
            progress: 0
          });
        });
        
        // 上传进度更新
        state.socket.on('uploadProgress', (data) => {
          const upload = state.uploads.get(data.uploadId);
          if (upload) {
            upload.progress = data.progress;
            state.uploads.set(data.uploadId, upload);
            ui.updateUploadProgress(data.progress, upload.fileName, data.progress);
          }
        });
        
        // 上传完成
        state.socket.on('uploadComplete', (data) => {
          const upload = state.uploads.get(data.uploadId);
          if (upload) {
            ui.updateUploadProgress(100, upload.fileName, 100);
            state.uploads.delete(data.uploadId);
            ui.showNotification(`文件上传完成`, 'success');
          }
        });
        
        // 语音上传初始化响应
        state.socket.on('voiceUploadInitialized', (data) => {
          state.uploads.set(data.uploadId, {
            id: data.uploadId,
            type: 'voice',
            fileSize: data.fileSize,
            progress: 0
          });
        });
        
        // 语音上传进度更新
        state.socket.on('voiceUploadProgress', (data) => {
          const upload = state.uploads.get(data.uploadId);
          if (upload) {
            upload.progress = data.progress;
            state.uploads.set(data.uploadId, upload);
            ui.updateUploadProgress(data.progress, '语音消息', data.progress);
          }
        });
        
        // 语音上传完成
        state.socket.on('voiceUploadComplete', (data) => {
          const upload = state.uploads.get(data.uploadId);
          if (upload) {
            ui.updateUploadProgress(100, '语音消息', 100);
            state.uploads.delete(data.uploadId);
            ui.showNotification(`语音消息发送成功`, 'success');
          }
        });
        
        // 文件过期更新
        state.socket.on('fileExpiryUpdated', (data) => {
          ui.showNotification(`文件保质期已更新为 ${data.expiryTimeFormatted}`, 'info');
        });
        
        // 文件过期通知
        state.socket.on('fileExpired', (data) => {
          ui.showNotification(`文件 ${data.fileName} 已过期`, 'info');
        });
        
        // 会话文件列表
        state.socket.on('conversationFiles', (data) => {
          ui.updateFileList(data.files);
        });
        
        // 错误处理
        state.socket.on('uploadError', (data) => {
          ui.showNotification(`上传失败: ${data.error}`, 'error');
          elements.uploadProgressContainer.classList.add('hidden');
        });
        
        state.socket.on('voiceError', (data) => {
          ui.showNotification(`语音处理失败: ${data.error}`, 'error');
          elements.voiceRecordingIndicator.classList.add('hidden');
        });
        
        state.socket.on('messageError', (message) => {
          ui.showNotification(`消息发送失败: ${message}`, 'error');
        });
        
        state.socket.on('fileError', (data) => {
          ui.showNotification(`文件操作失败: ${data.error}`, 'error');
        });
        
        state.socket.on('storageError', (data) => {
          ui.showNotification(`存储信息获取失败: ${data.message}`, 'error');
        });
      },
      
      // 登出
      logout() {
        if (state.socket) {
          state.socket.disconnect();
        }
        
        // 重置状态
        state.socket = null;
        state.currentUser = null;
        state.currentChat = null;
        state.users.clear();
        state.rooms.clear();
        state.friends.clear();
        state.friendRequests = [];
        state.messages.clear();
        state.files.clear();
        
        // 显示登录界面
        elements.app.classList.add('hidden');
        elements.loginScreen.classList.remove('hidden');
        elements.usernameInput.value = '';
      },
      
      // 发送消息
      sendMessage() {
        if (!state.currentChat || !state.socket) return;
        
        const text = elements.messageInput.value.trim();
        if (!text) return;
        
        // 构建消息
        const message = {
          text: state.isEncrypting ? utils.encryptMessage(text) : text,
          isEncrypted: state.isEncrypting,
          expiryTime: state.selectedExpiryTime
        };
        
        // 根据聊天类型设置目标
        if (state.currentChat.type === 'room') {
          message.roomId = state.currentChat.id;
        } else {
          message.targetUserId = state.currentChat.targetUserId;
        }
        
        // 发送消息
        state.socket.emit('chatMessage', message);
        
        // 清空输入框
        elements.messageInput.value = '';
        elements.sendMessageBtn.disabled = true;
      },
      
      // 创建房间
      createRoom(roomName) {
        if (!state.socket) return;
        state.socket.emit('createRoom', roomName);
      },
      
      // 发送好友请求
      sendFriendRequest(userId) {
        if (!state.socket) return;
        state.socket.emit('sendFriendRequest', userId);
      },
      
      // 上传文件
      uploadFile() {
        if (!state.currentChat || !state.socket) {
          ui.showNotification('请先选择一个聊天', 'warning');
          return;
        }
        
        // 创建文件选择器
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = false;
        
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          // 初始化上传
          const target = state.currentChat.type === 'room' 
            ? { roomId: state.currentChat.id } 
            : { userId: state.currentChat.targetUserId };
          
          state.socket.emit('initFileUpload', {
            name: file.name,
            size: file.size,
            expiryTime: state.selectedExpiryTime,
            target: target
          });
          
          // 监听上传初始化响应后再进行实际上传
          const handleUploadInitialized = (data) => {
            if (data.fileName !== file.name) return;
            
            // 移除监听器
            state.socket.off('uploadInitialized', handleUploadInitialized);
            
            // 创建FormData并上传文件
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            
            // 上传进度
            xhr.upload.addEventListener('progress', (e) => {
              if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                state.socket.emit('updateUploadProgress', {
                  uploadId: data.uploadId,
                  uploaded: e.loaded
                });
              }
            });
            
            // 上传完成
            xhr.addEventListener('load', () => {
              if (xhr.status === 200) {
                state.socket.emit('completeFileUpload', {
                  uploadId: data.uploadId,
                  sendOriginal: file.type.startsWith('image/')
                });
              } else {
                ui.showNotification('文件上传失败', 'error');
              }
            });
            
            xhr.send(formData);
          };
          
          state.socket.on('uploadInitialized', handleUploadInitialized);
        });
        
        fileInput.click();
      },
      
      // 开始录制语音
      startVoiceRecording() {
        if (!state.currentChat || !state.socket) {
          ui.showNotification('请先选择一个聊天', 'warning');
          return;
        }
        
        // 检查浏览器支持
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          ui.showNotification('您的浏览器不支持语音录制', 'error');
          return;
        }
        
        // 显示录制指示器
        elements.voiceRecordingIndicator.classList.remove('hidden');
        
        // 获取媒体流
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            // 创建MediaRecorder
            const mediaRecorder = new MediaRecorder(stream);
            const audioChunks = [];
            
            // 存储到状态
            state.voiceRecording = {
              stream: stream,
              recorder: mediaRecorder,
              chunks: audioChunks,
              startTime: Date.now()
            };
            
            // 开始录制
            mediaRecorder.start();
            mediaRecorder.addEventListener('dataavailable', (e) => {
              audioChunks.push(e.data);
            });
          })
          .catch(error => {
            console.error('语音录制错误:', error);
            ui.showNotification('无法访问麦克风，请检查权限', 'error');
            elements.voiceRecordingIndicator.classList.add('hidden');
          });
      },
      
      // 取消语音录制
      cancelVoiceRecording() {
        if (state.voiceRecording) {
          // 停止录制
          state.voiceRecording.recorder.stop();
          state.voiceRecording.stream.getTracks().forEach(track => track.stop());
          state.voiceRecording = null;
        }
        
        // 隐藏录制指示器
        elements.voiceRecordingIndicator.classList.add('hidden');
      },
      
      // 停止并发送语音
      stopVoiceRecording() {
        if (!state.voiceRecording) return;
        
        const { recorder, stream, startTime, chunks } = state.voiceRecording;
        const duration = Date.now() - startTime;
        
        // 停止录制
        recorder.stop();
        stream.getTracks().forEach(track => track.stop());
        
        // 隐藏录制指示器
        elements.voiceRecordingIndicator.classList.add('hidden');
        
        // 处理录制的音频
        recorder.addEventListener('stop', () => {
          const audioBlob = new Blob(chunks, { type: 'audio/webm' });
          
          // 初始化语音上传
          const target = state.currentChat.type === 'room' 
            ? { roomId: state.currentChat.id } 
            : { userId: state.currentChat.targetUserId };
          
          state.socket.emit('initVoiceUpload', {
            duration: duration,
            size: audioBlob.size,
            target: target
          });
          
          // 监听上传初始化响应
          const handleVoiceUploadInitialized = (data) => {
            state.socket.off('voiceUploadInitialized', handleVoiceUploadInitialized);
            
            // 创建FormData并上传
            const formData = new FormData();
            formData.append('voice', audioBlob, `voice-${Date.now()}.webm`);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload-voice', true);
            
            // 上传进度
            xhr.upload.addEventListener('progress', (e) => {
              if (e.lengthComputable) {
                state.socket.emit('updateVoiceUploadProgress', {
                  uploadId: data.uploadId,
                  uploaded: e.loaded
                });
              }
            });
            
            // 上传完成
            xhr.addEventListener('load', () => {
              if (xhr.status === 200) {
                state.socket.emit('completeVoiceUpload', {
                  uploadId: data.uploadId
                });
              } else {
                ui.showNotification('语音上传失败', 'error');
              }
            });
            
            xhr.send(formData);
          };
          
          state.socket.on('voiceUploadInitialized', handleVoiceUploadInitialized);
          
          // 清除状态
          state.voiceRecording = null;
        });
      },
      
      // 获取会话文件列表
      getConversationFiles() {
        if (!state.currentChat || !state.socket) return;
        
        state.socket.emit('getConversationFiles', {
          conversationType: state.currentChat.type,
          conversationId: state.currentChat.id
        });
      },
      
      // 更新文件保质期
      updateFileExpiry(fileId, newExpiryTime) {
        if (!state.socket) return;
        
        state.socket.emit('updateFileExpiry', {
          fileId: fileId,
          newExpiryTime: newExpiryTime
        });
      }
    };

    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
      events.init();
    });
  </script>
</body>
</html>
